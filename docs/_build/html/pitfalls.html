<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Common problems &mdash; Python Media Streaming Framework for Linux  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Debugging" href="debugging.html" />
    <link rel="prev" title="OnVif &amp; Discovery" href="onvif.html" />
<!-- as per https://stackoverflow.com/questions/23211695/modifying-content-width-of-the-sphinx-theme-read-the-docs -->
<link href="_static/rtd_override.css" rel="stylesheet" type="text/css">
<script src="https://kit.fontawesome.com/1f90d3565b.js" crossorigin="anonymous"></script>

<style>
    .list-container {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        color: #333;
        line-height: 1.6;
        margin-bottom: 20px;
    }
    .list-container ul {
        list-style: none; /* Remove bullets */
        padding: 0; /* Remove default padding */
    }
    .list-container ul li {
        margin-bottom: 8px;
        text-align: left; /* Align text to the left */
        color: white; /* Set text color to white */
        margin-left: 20px; /* Add margin to the left */
    }
    /* Style hyperlinks within .list-container */
    .list-container a {
        color: white; /* Default color */
        text-decoration: none; /* Remove underline */
    }

    /* Change hyperlink color on hover within .list-container */
    .list-container a:hover {
        color: grey; /* Color when hovered over */
    }
</style>


</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

<!--
  <a href="index.html" class="icon icon-home"> Python Media Streaming Framework for Linux
-->

<!--

NO LOGO
-->

<!--
NOTE: we are starting to have "version creep" here..  at the moment, with Sphinx==7.2.6 and sphinx-rtd-theme==1.3.0 the only thing that
works is this:
-->
<a href="index.html">
<img src="_static/logo.png" class="logo" style="width: 200px; height: auto; border-radius: 0px 6px 6px 0px;" alt="Logo"/>
</a>
    <div class="version">
      1.6.1
    </div>

<!-- font awesome comes with the rtd package.. use like this:-->

<div class="list-container">
<ul>
<li><a href="https://github.com/elsampsa/valkka-core" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-core </a></li>
<li><a href="https://github.com/elsampsa/valkka-examples" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-examples </a></li>
<li><a href="https://github.com/elsampsa/valkka-onvif" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-onvif </a></li>
<li><a href="https://elsampsa.github.io/valkka-multiprocess/_build/html/index.html" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-multiprocess </a></li>
<li><a href="https://github.com/elsampsa/valkka-streamer"target="_blank" rel="noopener noreferrer" ><i class="fab fa-github" ></i> valkka-streamer </a></li>
<!-- li><a href="https://github.com/elsampsa/darknet-python"><i class="fab fa-github"></i> darknet-python </a></li -->
<li><a href="https://github.com/elsampsa/valkka-core/issues" target="_blank" rel="noopener noreferrer"><i class="fas fa-bug"></i> Issue Tracker</a></li>
<li><a href="https://launchpad.net/~sampsa-riikonen/+archive/ubuntu/valkka/+packages" target="_blank" rel="noopener noreferrer"><i class="fas fa-archive"></i> Package Repository</a></li>
<li><a href="https://hub.docker.com/r/elsampsa/valkka" target="_blank" rel="noopener noreferrer"><i class="fab fa-docker"></i> Dockerhub</a></li>
<li><a href="https://elsampsa.github.io/valkka-live/" target="_blank" rel="noopener noreferrer"><i class="fas fa-video"></i> Valkka Live</a></li>
<li><a href="https://discord.com/channels/1116100310574837812/1116101208797609994" target="_blank" rel="noopener noreferrer"> <i class="fa-brands fa-discord"></i> Discord </a> </li>
<!-- li><a href="http://www.dasys.fi"><i class="fas fa-building"></i> Dasys Ltd.</a></li -->
</ul>
</div>
<!-- don't even think about subclassing searchbox.html .. will never work!-->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">About Valkka</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware.html">Supported hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="testsuite.html">The PyQt testsuite</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="decoding.html">Decoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="qt_notes.html">Integrating with Qt and multiprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_gpu.html">Multi-GPU systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="valkkafs.html">ValkkaFS</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud.html">Cloud Streaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="onvif.html">OnVif &amp; Discovery</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Common problems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pitfalls">Pitfalls</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bottlenecks">Bottlenecks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#system-tuning">System tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="#faq">FAQ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="repos.html">Repository Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">Licence &amp; Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="knowledge.html">Knowledge Base</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Python Media Streaming Framework for Linux</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Common problems</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/pitfalls.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="common-problems">
<h1>Common problems<a class="headerlink" href="#common-problems" title="Link to this heading"></a></h1>
<section id="pitfalls">
<span id="id1"></span><h2>Pitfalls<a class="headerlink" href="#pitfalls" title="Link to this heading"></a></h2>
<p>Valkka has been designed for massive video streaming.
If your linux box, running a Valkka-based program, starts to choke up and you get frame jittering, stuttering / video freezes, and typically, this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OpenGLThread</span><span class="p">:</span> <span class="n">handleFifo</span><span class="p">:</span> <span class="n">DISCARDING</span> <span class="n">late</span> <span class="n">frame</span> <span class="o">...</span>
</pre></div>
</div>
<p>You should consider the following issues:</p>
<p><strong>0. Are you using correct Valkka version?</strong></p>
<p>Use the latest version.  When running the PyQt testsuite, remember to run <em>quicktest.py</em> to see if your installation is consistent.</p>
<p><strong>1. Are you using sub-standard cameras?</strong></p>
<p>Nowadays the image quality is impressive in all stock IP cameras, however, the rtsp server and/or timestamping of the cameras can be buggy
(there might be problems when maintaining several connections to the same camera, or when re-connecting several times to the same camera).</p>
<p>Before blaming us, <em>generate the same situation with a reference program</em>, say with ffplay, and see if it works or not.
The <a class="reference internal" href="testsuite.html#testsuite"><span class="std std-ref">PyQt testsuite</span></a> offers nice tools for benchmarking agains ffplay and vlc.</p>
<p><strong>2. Is your PC powerful enough to decode simultaneously 4+ full-hd videos?</strong></p>
<p><em>Test against a reference program</em> (ffplay).  Launch KSysGuard to monitor your processor usage.  Read also <a class="reference internal" href="decoding.html#decoding"><span class="std std-ref">this</span></a>.</p>
<p><strong>3. Have you told Valkka to reserve enough bitmap frames on the GPU?  Is your buffering time too large?</strong></p>
<p>The issue of pre-reserved frames and buffering time has been discussed <a class="reference internal" href="decoding.html#decoding"><span class="std std-ref">here</span></a> and in the <a class="reference internal" href="testsuite.html#testsuite-decode"><span class="std std-ref">PyQt testsuite section</span></a>.</p>
<p><strong>4. Disable OpenGL rendering synchronization to vertical refresh (“vsync”).</strong></p>
<p>On MESA based X.org drivers (intel, nouveau, etc.), this can be achieved from command line with “export vblank_mode=0”.  With nvidia proprietary drivers, use the <em>nvidia-settings</em> program.</p>
<p>Test if vsync is disabled with the “glxgears” command.  It should report 1000+ frames per second with vsync disabled.</p>
<p><strong>5. Disable OpenGL composition.</strong></p>
<p>In a KDE based system, go to <em>System Settings =&gt; Display and Monitor =&gt; Compositor</em> and uncheck “Enable compositor on startup”.
After that, you still have to restart your X-server (i.e. do logout and login).  CTRL-ALT-F12 might also work.
In Xcfe based desktop, do <em>Settings Manager -&gt; Window Manager Tweaks -&gt; Compositor -&gt; uncheck Enable Display Compositor</em>.</p>
<p>Alternatively, you can user this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dbus</span> <span class="n">org</span><span class="o">.</span><span class="n">kde</span><span class="o">.</span><span class="n">KWin</span> <span class="o">/</span><span class="n">Compositor</span> <span class="n">suspend</span>
</pre></div>
</div>
<p><strong>6. Is your IP camera’s time set correctly?</strong></p>
<p>Valkka tries hard to correct the timestamps of arriving frames, but if the timestamps are “almost” right (i.e. off by a second or so),
there is no way to know if the frames are stamped incorrectly or if they really arrive late..!</p>
<p>So, either set your IP camera’s clock really off (say, 5+ mins off) or exactly to the correct time.
In the latter case, you might want to sync both your IP camera and PC to the same NTP server.</p>
<p><strong>7. Are you really using a gigabit nic?</strong></p>
<p>How’s your network interface hardware?  Using an old usb dongle?  Check your nic’s capacity with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">net</span><span class="o">/&lt;</span><span class="n">device_name</span><span class="o">&gt;/</span><span class="n">speed</span>
</pre></div>
</div>
<p>It should say at least “100”, preferably “1000”</p>
</section>
<section id="bottlenecks">
<h2>Bottlenecks<a class="headerlink" href="#bottlenecks" title="Link to this heading"></a></h2>
<p>Once you ramp up the number of streams, you might start to experience some <em>real</em> performance issues.  Some typical problems include:</p>
<p><strong>8. Your LAN and/or the LiveThread process sending frames in bursts</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>Frames arrive late, and all in once.  You should increase the buffering time OpenGLThread.  See <a class="reference internal" href="decoding.html#buffering"><span class="std std-ref">here</span></a>.</p></li>
<li><p>This is very common problem when streaming over Wifi</p></li>
<li><p>If you observe broken frames, most likely your network interface is not keeping up.  What is the bandwith of your network and nic ? (as we just discussed.  See also “System tuning” below)</p></li>
</ul>
</div></blockquote>
<p><strong>9. The AVThread(s) performing the decoding and uploading to GPU are taking too long</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>This is to be expected if all your CPU(s) are screaming 100%, so check that.</p></li>
</ul>
</div></blockquote>
<p><strong>10. OpenGLThread is stalling</strong></p>
<p>If you have tried everything suggested on this page so far, but you’re still getting</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OpenGLThread</span><span class="p">:</span> <span class="n">handleFifo</span><span class="p">:</span> <span class="n">DISCARDING</span> <span class="n">late</span> <span class="n">frame</span> <span class="o">...</span>
</pre></div>
</div>
<p>Then the problem is in the last part of the pipeline: the OpenGLThread.</p>
<p>It performs image interpolation and various other OpenGL calls, that, depending
on your driver’s OpenGL implementation, might be efficient or not.  Generally, NVidia seems to perform better that Intel.</p>
<p>If you compile libValkka from source, there are many available debug options that can be enabled in <em>run_cmake.bash</em>.
A particularly useful ones are <em>profile_timing</em> and <em>opengl_timing</em>.  Enabling these debug switch allows you to trace the culprit for frame dropping to slow network, slow decoding or the OpenGL part.</p>
<p>Some common fixes (that are frequently used in commercial video surveillance applications) include:</p>
<ul class="simple">
<li><p>Configure your cameras to a lower frame rate (say, 10 fps): unfortunately this sucks.</p></li>
<li><p>Tell AVThread to decode only keyframes: choppy video.</p></li>
<li><p>The mainstream/substream scheme:</p>
<ul>
<li><p>If you have, say, 20 small-sized video streams in your grid, it is an exaggeration to decode full-HD video for each one of the streams.</p></li>
<li><p>For small windows, you should switch to using a substream provided by your IP camera.  A resolution of, say, half of HD-ready might be enough.</p></li>
<li><p>Decode and present the full-HD mainstream only when there are video windows that are large enough</p></li>
</ul>
</li>
</ul>
<p>Valkka provides (or will provide) API methods and FrameFilter(s) to implement each one of these strategies.</p>
<p><strong>11. Packet drop</strong></p>
<p>Maybe might have saturated your NIC (see also above (7))?  Check in your camera’s web-interface/config the bandwith it is using.  Typical values
are (which you can adjust): 2048 kbps (~2 mbps), 4096kbps (~4 mbps), etc. so do the math.</p>
<p>You can try to use TCP streaming instead of the default UDP streaming -
see FAQ (a) below (valkka-live tip: you can choose TCP streaming in the camera configuration)</p>
</section>
<section id="system-tuning">
<h2>System tuning<a class="headerlink" href="#system-tuning" title="Link to this heading"></a></h2>
<p>Adding the following lines into <em>/etc/syscntl.conf</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vm</span><span class="o">.</span><span class="n">swappiness</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">wmem_max</span><span class="o">=</span><span class="mi">2097152</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">rmem_max</span><span class="o">=</span><span class="mi">2097152</span>
</pre></div>
</div>
<p>And running</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sysctl</span> <span class="o">-</span><span class="n">p</span>
</pre></div>
</div>
<p>Turns off swap and sets maximum allowed read/write socket sizes to 2 MB.</p>
<p>Receiving socket size can be adjusted for each live connection with the associated <em>LiveConnectionContext</em> (see the tutorial).</p>
</section>
<section id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Link to this heading"></a></h2>
<p><em>(a) How can I stream over internet, instead of just LAN?</em></p>
<p>By default, stream is transported through UDP sockets.  When streaming over internet, most of the ports are closed due to firewalls, etc., so you have to stream through the same TCP port
that is used for the RTSP negotiation (typically port 554).</p>
<p>Modify your LiveConnectionContext like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctx</span> <span class="o">=</span><span class="n">LiveConnectionContext</span><span class="p">(</span><span class="n">LiveConnectionType_rtsp</span><span class="p">,</span> <span class="s2">&quot;rtsp://admin:nordic12345@192.168.1.41&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">live_out_filter</span><span class="p">)</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">request_tcp</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>(for more information, see <a class="reference external" href="https://elsampsa.github.io/valkka-core/html/structLiveConnectionContext.html">here</a>)</p>
<p><em>(b) Could not load the Qt platform plugin “xcb”</em></p>
<p>If you get this error:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qt</span><span class="o">.</span><span class="n">qpa</span><span class="o">.</span><span class="n">plugin</span><span class="p">:</span> <span class="n">Could</span> <span class="ow">not</span> <span class="n">load</span> <span class="n">the</span> <span class="n">Qt</span> <span class="n">platform</span> <span class="n">plugin</span> <span class="s2">&quot;xcb&quot;</span> <span class="ow">in</span> <span class="s2">&quot;&quot;</span> <span class="n">even</span> <span class="n">though</span> <span class="n">it</span> <span class="n">was</span> <span class="n">found</span><span class="o">.</span>
</pre></div>
</div>
<p>Then you are <em>not</em> running valkka-live directly in a desktop, but from remote etc. connection (or in docker, etc. “headless” environment).</p>
<p>It has really nothing to do with libValkka or valkka-live.  In fact, <em>none</em> of your Qt and KDE-based desktop programs would work at all.  Check with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>echo $XDG_SESSION_TYPE
</pre></div>
</div>
<p>and make sure that it reports the value <cite>x11</cite>.</p>
<p>If the error persists, you’re desktop environment might have missing or broken Qt/KDE dependencies.  Install the whole KDE and Qt stack with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">kate</span>
</pre></div>
</div>
<p>(this pulls a minimal KDE + Qt installation as dependencies of the Kate editor)</p>
<p>If this error <em>still</em> persists and is reported by python’s cv2 module, you have a broken cv2 version, so uninstall cv2 with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip3</span> <span class="n">uninstall</span> <span class="n">opencv</span><span class="o">-</span><span class="n">python</span>
<span class="n">sudo</span> <span class="n">pip3</span> <span class="n">uninstall</span> <span class="n">opencv</span><span class="o">-</span><span class="n">python</span> <span class="c1"># just in case!</span>
</pre></div>
</div>
<p>And install your linux distro’s default opencv instead with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">opencv</span>
</pre></div>
</div>
<p><em>(c) VAAPI decoder always defaults to software decoder</em></p>
<p>If your <a class="reference internal" href="hardware.html#hwaccel"><span class="std std-ref">VAAPI hw decoding</span></a> doesn’t work and libValkka
always reports that it reverts to software decoding, then you should run
on your terminal</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">LIBVA_DRIVER_NAME</span><span class="o">=</span>i965<span class="w"> </span>vainfo
</pre></div>
</div>
<p>If it reports problems, then you probably have a drm (direct-rendering management)
rights issue.  These appear typically if you use some weirdo windows program to
login to a remote machine (instead of standard SSH shell).</p>
<p>So don’t use weirdo windows terminal programs for remote access, please.</p>
<p>In docker, you need to enable docker to access the drivers.  Please see the information
in valkka dockerhub pages.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="onvif.html" class="btn btn-neutral float-left" title="OnVif &amp; Discovery" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="debugging.html" class="btn btn-neutral float-right" title="Debugging" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2020 Sampsa Riikonen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>