<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>The PyQt testsuite &#8212; Python Media Streaming Framework for Linux  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=e785833e" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tutorial" href="tutorial.html" />
    <link rel="prev" title="Installing" href="requirements.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="the-pyqt-testsuite">
<span id="testsuite"></span><h1>The PyQt testsuite<a class="headerlink" href="#the-pyqt-testsuite" title="Link to this heading">¶</a></h1>
<p>So, you have installed valkka-core and valkka-examples as instructed <a class="reference internal" href="requirements.html#requirements"><span class="std std-ref">here</span></a>.  The same hardware requirements apply here as in the <a class="reference internal" href="tutorial.html#tutorial"><span class="std std-ref">tutorial</span></a>.</p>
<p>The PyQt testsuite is available at</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">valkka_examples</span><span class="o">/</span><span class="n">api_level_2</span><span class="o">/</span><span class="n">qt</span><span class="o">/</span>
</pre></div>
</div>
<p>The testsuite is intended for:</p>
<blockquote>
<div><ul class="simple">
<li><p>Demonstration</p></li>
<li><p>Benchmarking</p></li>
<li><p>Ultimate debugging</p></li>
<li><p>As <em>materia prima</em> for developers - take a copy of your own and use it as a basis for your own Valkka / Qt program</p></li>
</ul>
</div></blockquote>
<p>If you want a more serious demonstration, try out <a class="reference external" href="https://elsampsa.github.io/valkka-live/">Valkka Live</a> instead.</p>
<p>Currently the testsuite consists of the following programs:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>File</p></th>
<th class="head"><p>Explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>test_studio_1.py</p></td>
<td><div class="line-block">
<div class="line">- Stream from several rtsp cameras or sdp sources</div>
<div class="line">- Widgets are grouped together</div>
<div class="line">- This is just live streaming, so use:</div>
<div class="line"><br /></div>
<div class="line-block">
<div class="line"><em>rtsp://username:password&#64;your_ip</em></div>
<div class="line"><br /></div>
</div>
<div class="line">- If you define a filename, it is interpreted as an sdp file</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>test_studio_2.py</p></td>
<td><div class="line-block">
<div class="line">- Like <em>test_studio_1.py</em></div>
<div class="line">- Floating widgets</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>test_studio_3.py</p></td>
<td><div class="line-block">
<div class="line">- Like <em>test_studio_2.py</em></div>
<div class="line">- On a multi-gpu system, video can be sent to another gpu/x-screen pair</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>test_studio_4.py</p></td>
<td><div class="line-block">
<div class="line">- Like <em>test_studio_3.py</em></div>
<div class="line">- A simple user menu where video widgets can be opened</div>
<div class="line">- Open the <em>File</em> menu to add video on the screen</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>test_studio_detector.py</p></td>
<td><div class="line-block">
<div class="line">- Like <em>test_studio_1.py</em></div>
<div class="line">- Shares video to OpenCV processes</div>
<div class="line">- OpenCV processes connect to Qt signal/slot system</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>test_studio_file.py</p></td>
<td><div class="line-block">
<div class="line">- Read and play stream from a matroska file</div>
<div class="line">- Only matroska-contained h264 is accepted.</div>
<div class="line">- Convert your video to “ip-camera-like” stream with:</div>
<div class="line"><br /></div>
<div class="line-block">
<div class="line"><em>ffmpeg -i your_video_file -c:v h264 -r 10 -preset ultrafast</em></div>
<div class="line"><em>-profile:v baseline</em></div>
<div class="line"><em>-bsf h264_mp4toannexb -x264-params keyint=10:min-keyint=10</em></div>
<div class="line"><em>-an outfile.mkv</em></div>
<div class="line"><br /></div>
</div>
<div class="line">- If you’re recording directly from an IP camera, use:</div>
<div class="line"><br /></div>
<div class="line-block">
<div class="line"><em>ffmpeg -i rtsp://username:password&#64;your_ip -c:v copy -an outfile.mkv</em></div>
<div class="line"><br /></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>test_studio_multicast.py</p></td>
<td><div class="line-block">
<div class="line">- Like <em>test_studio_1.py</em></div>
<div class="line">- Recast multiple IP cameras into multicast</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>test_studio_rtsp.py</p></td>
<td><div class="line-block">
<div class="line">- Like <em>test_studio_1.py</em></div>
<div class="line">- Recast IP cameras to unicast.</div>
<div class="line">- Streams are accessible from local server:</div>
<div class="line"><br /></div>
<div class="line-block">
<div class="line"><em>rtsp://127.0.0.1:8554/streamN</em></div>
<div class="line"><br /></div>
<div class="line">(where <em>N</em> is the number of the camera)</div>
<div class="line"><br /></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>test_studio_5.py</p></td>
<td><div class="line-block">
<div class="line"><strong>Very experimental</strong></div>
<div class="line">- Prefer test_studio_6.py over this one</div>
<div class="line">- Continuous recording to <a class="reference internal" href="valkkafs.html#valkkafs"><span class="std std-ref">ValkkaFS</span></a></div>
<div class="line">- Dumps all streams to a single file (uses <code class="docutils literal notranslate"><span class="pre">ValkkaMultiFS</span></code>)</div>
<div class="line">- Simultaneous, interactive playback : use mouse clicks &amp; wheel to navigate the timeline</div>
<div class="line">- remove directory <code class="docutils literal notranslate"><span class="pre">fs_directory/</span></code> if the program refuses to start</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>test_studio_6.py</p></td>
<td><div class="line-block">
<div class="line"><strong>Experimental</strong></div>
<div class="line">- Continuous recording to <a class="reference internal" href="valkkafs.html#valkkafs"><span class="std std-ref">ValkkaFS</span></a></div>
<div class="line">- One file per stream (uses <code class="docutils literal notranslate"><span class="pre">ValkkaSingleFS</span></code>)</div>
<div class="line">- Simultaneous, interactive playback : use mouse clicks &amp; wheel to navigate the timeline</div>
<div class="line">- remove directory <code class="docutils literal notranslate"><span class="pre">fs_directory_*/</span></code> if the program refuses to start</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Before launching any of the testsuite programs you should be aware of the <a class="reference internal" href="pitfalls.html#pitfalls"><span class="std std-ref">common problems</span></a> of linux video streaming.</p>
<section id="test-studio-1-py">
<h2>test_studio_1.py<a class="headerlink" href="#test-studio-1-py" title="Link to this heading">¶</a></h2>
<p>Do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">valkka_examples</span><span class="o">/</span><span class="n">api_level_2</span><span class="o">/</span><span class="n">qt</span><span class="o">/</span>
<span class="n">python3</span> <span class="n">test_studio_1</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>The program launches with the following menu:</p>
<a class="reference internal image-reference" href="_images/test_config.png"><img alt="_images/test_config.png" src="_images/test_config.png" style="width: 70%;" /></a>
<p>The field on the left is used to specify stream sources, one source per line.  For IP cameras, use “<a class="reference external" href="rtsp://">rtsp://</a>”, for sdp files, just give the filename.  In the above example, we are connecting to two rtsp IP cams.</p>
<p>The fields on the right are:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Field name</p></th>
<th class="head"><p>What it does</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>n720p</p></td>
<td><p>Number of pre-reserved frames for 720p resolution</p></td>
</tr>
<tr class="row-odd"><td><p>n1080p</p></td>
<td><p>Number of pre-reserved frames for 1080p resolution</p></td>
</tr>
<tr class="row-even"><td><p>n1440p</p></td>
<td><p>etc.</p></td>
</tr>
<tr class="row-odd"><td><p>n4K</p></td>
<td><p>etc.</p></td>
</tr>
<tr class="row-even"><td><p>naudio</p></td>
<td><p>(not used)</p></td>
</tr>
<tr class="row-odd"><td><p>verbose</p></td>
<td><p>(not used)</p></td>
</tr>
<tr class="row-even"><td><p>msbuftime</p></td>
<td><p>Frame buffering time in milliseconds</p></td>
</tr>
<tr class="row-odd"><td><p>live affinity</p></td>
<td><p>Bind the streaming thread to a core. Default = -1 (no binding)</p></td>
</tr>
<tr class="row-even"><td><p>gl affinity</p></td>
<td><p>Bind frame presentation thread to a core. Default = -1</p></td>
</tr>
<tr class="row-odd"><td><p>dec affinity start</p></td>
<td><p>Bind decoding threads to a core (first core). Default = -1</p></td>
</tr>
<tr class="row-even"><td><p>dec affinity stop</p></td>
<td><p>Bind decoding threads to cores (last core). Default = -1</p></td>
</tr>
<tr class="row-odd"><td><p>replicate</p></td>
<td><p>Dump each stream to screen this many times</p></td>
</tr>
<tr class="row-even"><td><p>correct timestamp</p></td>
<td><div class="line-block">
<div class="line">1 = smart-correct timestamp (use this!)</div>
<div class="line">0 = restamp upon arrival</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>socket size bytes</p></td>
<td><p>don’t touch.  Default value = 0.</p></td>
</tr>
<tr class="row-even"><td><p>ordering time millisecs</p></td>
<td><p>don’t touch.  Default value = 0.</p></td>
</tr>
</tbody>
</table>
<p id="testsuite-decode">As you learned from the <a class="reference internal" href="tutorial.html#tutorial"><span class="std std-ref">tutorial</span></a>, in Valkka, frames are pre-reserved on the GPU.  If you’re planning to use 720p and 1080p cameras, reserve, say 200 frames for both.</p>
<p>Decoded frames are being queued for “msbuftime” milliseconds.  This is necessary for de-jitter (among other things).  The bigger the buffering time, the more pre-reserved frames you’ll need and the more lag you get into your live streaming.  A nice value is 300.  For more on the subject, read <a class="reference internal" href="decoding.html#decoding"><span class="std std-ref">this</span></a>.</p>
<p>Replicate demonstrates how Valkka can dump the stream (that’s decoded only once) to multiple X windows.  Try for example the value 24 - you get each stream on the screen 24 times, without any performance degradation or the need to decode streams more than once.</p>
<p>In Valkka, all threads can be bound to a certain processor core.  Default value “-1” indicates that the thread is unbound and that the kernel can switch it from one core to another (normal behaviour).</p>
<p>Let’s consider an example:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Field name</p></th>
<th class="head"><p>value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>live affinity</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>gl affinity</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>dec affinity start</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>dec affinity stop</p></td>
<td><p>4</p></td>
</tr>
</tbody>
</table>
<p>Now LiveThread (the thread that streams from cameras) stays at core index 0, all OpenGL operations and frame presenting at core index 1.  Let’s imagine you have ten decoders running, then they will placed like this:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Core</p></th>
<th class="head"><p>Decoder thread</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>core 2</p></td>
<td><p>1, 4, 7, 10</p></td>
</tr>
<tr class="row-odd"><td><p>core 3</p></td>
<td><p>2, 5, 8</p></td>
</tr>
<tr class="row-even"><td><p>core 4</p></td>
<td><p>3, 6, 9</p></td>
</tr>
</tbody>
</table>
<p>Setting processor affinities might help, if you can afford the luxury of having one processor per decoder.  Otherwise, it might mess up the load-balancing performed by the kernel.</p>
<p><strong>By default, don’t touch the affinities (simply use the default value -1)</strong>.</p>
<p>Finally, the buttons that launch the test, do the following:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Button</p></th>
<th class="head"><p>What it does?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SAVE</p></td>
<td><p>Saves the test configuration (yes, save it)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>RUN(QT)</strong></p></td>
<td><p>Runs THE TEST (after saving, press this!)</p></td>
</tr>
<tr class="row-even"><td><p>RUN</p></td>
<td><p>Runs the test without Qt</p></td>
</tr>
<tr class="row-odd"><td><p>FFPLAY</p></td>
<td><p>Runs the streams in ffplay instead (if installed)</p></td>
</tr>
<tr class="row-even"><td><p>VLC</p></td>
<td><p>Runs the streams in vlc instead (if installed)</p></td>
</tr>
</tbody>
</table>
<p><em>RUN(QT)</em> is the thing you want to do.</p>
<p><em>FFPLAY</em> and <em>VLC</em> launch the same rtsp streams by using either ffplay or vlc.  This is a nice test to see how Valkka performs against some popular video players.</p>
</section>
<section id="test-studio-detector-py">
<h2>test_studio_detector.py<a class="headerlink" href="#test-studio-detector-py" title="Link to this heading">¶</a></h2>
<p>The detector test program uses OpenCV, so you need to have it <a class="reference internal" href="requirements.html#install-opencv"><span class="std std-ref">installed</span></a></p>
<p>Launch the program like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">valkka_examples</span><span class="o">/</span><span class="n">api_level_2</span><span class="o">/</span><span class="n">qt</span><span class="o">/</span>
<span class="n">python3</span> <span class="n">test_studio_detector</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>This is similar to <em>test_studio_1.py</em>.  In addition to presenting the streams on-screen, the decoded frames are passed, once in a second, to OpenCV movement detectors.  When movement is detected, a signal is sent with the Qt signal/slot system to the screen.</p>
<p>This test program is also used in the <em>gold standard test</em>.  Everything is here: streaming, decoding, OpenGL streaming, interface to python and even the posix shared memory and semaphores.  One should be able to run this test with a large number of cameras for a long period of time without excessive memory consumption or system instabilities.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!--link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous"-->

<script src="https://kit.fontawesome.com/1f90d3565b.js" crossorigin="anonymous"></script>

<!-- Place this tag in your head or just before your close body tag. -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

<a href="index.html">
    <img class="logo" src="_static/valkka.png">
</a>

<p>Python Media Streaming Framework for Linux</p>
<a class="github-button" href="https://github.com/elsampsa/valkka-core" data-size="large" data-show-count="true" aria-label="Star elsampsa/valkka-core on GitHub">Star</a>
<!--
<p>
  <iframe src="http://ghbtns.com/github-btn.html?user=elsampsa&repo=valkka-core&type=watch&count=true&size=large" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>
-->

<h3>Links</h3>
<ul>
  <li><a href="https://github.com/elsampsa/valkka-core" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-core </a></li>
  <li><a href="https://github.com/elsampsa/valkka-examples" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-examples </a></li>
  <li><a href="https://github.com/elsampsa/valkka-onvif" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-onvif </a></li>
  <li><a href="https://elsampsa.github.io/valkka-multiprocess/_build/html/index.html" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-multiprocess </a></li>
  <li><a href="https://github.com/elsampsa/valkka-streamer"target="_blank" rel="noopener noreferrer" ><i class="fab fa-github" ></i> valkka-streamer </a></li>
  <!-- li><a href="https://github.com/elsampsa/darknet-python"><i class="fab fa-github"></i> darknet-python </a></li -->
  <li><a href="https://github.com/elsampsa/valkka-core/issues" target="_blank" rel="noopener noreferrer"><i class="fas fa-bug"></i> Issue Tracker</a></li>
  <li><a href="https://launchpad.net/~sampsa-riikonen/+archive/ubuntu/valkka/+packages" target="_blank" rel="noopener noreferrer"><i class="fas fa-archive"></i> Package Repository</a></li>
  <li><a href="https://hub.docker.com/r/elsampsa/valkka" target="_blank" rel="noopener noreferrer"><i class="fab fa-docker"></i> Dockerhub</a></li>
  <li><a href="https://elsampsa.github.io/valkka-live/" target="_blank" rel="noopener noreferrer"><i class="fas fa-video"></i> Valkka Live</a></li>
  <li><a href="https://discord.com/channels/1116100310574837812/1116101208797609994" target="_blank" rel="noopener noreferrer"> <i class="fa-brands fa-discord"></i> Discord </a> </li>
  <!-- li><a href="http://www.dasys.fi"><i class="fas fa-building"></i> Dasys Ltd.</a></li -->
</ul>

<!-- stupid widgetbot stopped working: let's not use it -->
<!--script src='https://cdn.jsdelivr.net/npm/@widgetbot/crate@3' async defer>
    new Crate({
        server: '1116100310574837812', // ElSampsa's kindergarden
        channel: '1116101208797609994' // #valkka
    })
</script-->
<h3><a href="index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">About Valkka</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware.html">Supported hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Installing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The PyQt testsuite</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#test-studio-1-py">test_studio_1.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-studio-detector-py">test_studio_detector.py</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="decoding.html">Decoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="qt_notes.html">Integrating with Qt and multiprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_gpu.html">Multi-GPU systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="valkkafs.html">ValkkaFS</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud.html">Cloud Streaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="onvif.html">OnVif &amp; Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="pitfalls.html">Common problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="repos.html">Repository Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">Licence &amp; Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="knowledge.html">Knowledge Base</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2017-2020 Sampsa Riikonen.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.15</a>
      
      |
      <a href="_sources/testsuite.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
    <script>

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-123031237-1']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>