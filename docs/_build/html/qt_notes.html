<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Integrating with Qt and multiprocessing &mdash; Python Media Streaming Framework for Linux  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Multi-GPU systems" href="multi_gpu.html" />
    <link rel="prev" title="Decoding" href="decoding.html" />
<!-- as per https://stackoverflow.com/questions/23211695/modifying-content-width-of-the-sphinx-theme-read-the-docs -->
<link href="_static/rtd_override.css" rel="stylesheet" type="text/css">
<script src="https://kit.fontawesome.com/1f90d3565b.js" crossorigin="anonymous"></script>

<style>
    .list-container {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        color: #333;
        line-height: 1.6;
        margin-bottom: 20px;
    }
    .list-container ul {
        list-style: none; /* Remove bullets */
        padding: 0; /* Remove default padding */
    }
    .list-container ul li {
        margin-bottom: 8px;
        text-align: left; /* Align text to the left */
        color: white; /* Set text color to white */
        margin-left: 20px; /* Add margin to the left */
    }
    /* Style hyperlinks within .list-container */
    .list-container a {
        color: white; /* Default color */
        text-decoration: none; /* Remove underline */
    }

    /* Change hyperlink color on hover within .list-container */
    .list-container a:hover {
        color: grey; /* Color when hovered over */
    }
</style>


</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

<!--
  <a href="index.html" class="icon icon-home"> Python Media Streaming Framework for Linux
-->

<!--

NO LOGO
-->

<!--
NOTE: we are starting to have "version creep" here..  at the moment, with Sphinx==7.2.6 and sphinx-rtd-theme==1.3.0 the only thing that
works is this:
-->
<a href="index.html">
<img src="_static/logo.png" class="logo" style="width: 200px; height: auto; border-radius: 0px 6px 6px 0px;" alt="Logo"/>
</a>
    <div class="version">
      1.6.1
    </div>

<!-- font awesome comes with the rtd package.. use like this:-->

<div class="list-container">
<ul>
<li><a href="https://github.com/elsampsa/valkka-core" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-core </a></li>
<li><a href="https://github.com/elsampsa/valkka-examples" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-examples </a></li>
<li><a href="https://github.com/elsampsa/valkka-onvif" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-onvif </a></li>
<li><a href="https://elsampsa.github.io/valkka-multiprocess/_build/html/index.html" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-multiprocess </a></li>
<li><a href="https://github.com/elsampsa/valkka-streamer"target="_blank" rel="noopener noreferrer" ><i class="fab fa-github" ></i> valkka-streamer </a></li>
<!-- li><a href="https://github.com/elsampsa/darknet-python"><i class="fab fa-github"></i> darknet-python </a></li -->
<li><a href="https://github.com/elsampsa/valkka-core/issues" target="_blank" rel="noopener noreferrer"><i class="fas fa-bug"></i> Issue Tracker</a></li>
<li><a href="https://launchpad.net/~sampsa-riikonen/+archive/ubuntu/valkka/+packages" target="_blank" rel="noopener noreferrer"><i class="fas fa-archive"></i> Package Repository</a></li>
<li><a href="https://hub.docker.com/r/elsampsa/valkka" target="_blank" rel="noopener noreferrer"><i class="fab fa-docker"></i> Dockerhub</a></li>
<li><a href="https://elsampsa.github.io/valkka-live/" target="_blank" rel="noopener noreferrer"><i class="fas fa-video"></i> Valkka Live</a></li>
<li><a href="https://discord.com/channels/1116100310574837812/1116101208797609994" target="_blank" rel="noopener noreferrer"> <i class="fa-brands fa-discord"></i> Discord </a> </li>
<!-- li><a href="http://www.dasys.fi"><i class="fas fa-building"></i> Dasys Ltd.</a></li -->
</ul>
</div>
<!-- don't even think about subclassing searchbox.html .. will never work!-->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">About Valkka</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware.html">Supported hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="testsuite.html">The PyQt testsuite</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="decoding.html">Decoding</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Integrating with Qt and multiprocessing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#qt-integration">Qt integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#drawing-video-into-a-widget">Drawing video into a widget</a></li>
<li class="toctree-l2"><a class="reference internal" href="#python-multiprocessing">Python multiprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#c-api">C++ API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="multi_gpu.html">Multi-GPU systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="valkkafs.html">ValkkaFS</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud.html">Cloud Streaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="onvif.html">OnVif &amp; Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="pitfalls.html">Common problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="repos.html">Repository Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">Licence &amp; Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="knowledge.html">Knowledge Base</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Python Media Streaming Framework for Linux</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Integrating with Qt and multiprocessing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/qt_notes.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="integrating-with-qt-and-multiprocessing">
<h1>Integrating with Qt and multiprocessing<a class="headerlink" href="#integrating-with-qt-and-multiprocessing" title="Link to this heading"></a></h1>
<section id="qt-integration">
<h2>Qt integration<a class="headerlink" href="#qt-integration" title="Link to this heading"></a></h2>
<p>Valkka can be used with any GUI framework, say, with GTK or Qt.  Here we have an emphasis on Qt, but the general guidelines discussed here, apply to any other GUI framework as well.
Concrete examples are provided only for Qt.</p>
<p>At the GUI’s main window constructor:</p>
<ol class="arabic simple">
<li><p>Start your python multiprocesses if you have them (typically used for machine vision analysis)</p></li>
<li><p>Instantiate filtergraphs (from dedicated filtergraph classes, like we did in <a class="reference internal" href="lesson_3.html#multiple-streams"><span class="std std-ref">tutorial</span></a>)</p></li>
<li><p>Start all libValkka threads (LiveThread, OpenGLThread, etc.)</p></li>
<li><p>Start a QThread listening to your python multiprocesses (1), in order to translate messages from multiprocesses to Qt signals.</p></li>
</ol>
<p>Finally:</p>
<ol class="arabic simple" start="5">
<li><p>Start your GUI framework’s execution loop</p></li>
<li><p>At main window close event, close all threads, filterchains and multiprocesses</p></li>
</ol>
<p>Examples of all this can be found in <a class="reference internal" href="testsuite.html#testsuite"><span class="std std-ref">the PyQt testsuite</span></a> together with several filtergraph classes.</p>
</section>
<section id="drawing-video-into-a-widget">
<h2>Drawing video into a widget<a class="headerlink" href="#drawing-video-into-a-widget" title="Link to this heading"></a></h2>
<p>X-windows, i.e. “widgets” in the Qt slang, can be created at the Qt side and passed to Valkka.  Alternatively, x-windows can be created at the Valkka side and passed to Qt as “foreign widgets”.</p>
<p>As you learned in the tutorial, we use the X-window window ids like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">context_id</span><span class="o">=</span><span class="n">glthread</span><span class="o">.</span><span class="n">newRenderContextCall</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">window_id</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>That creates a mapping: all frames with slot number “1” are directed to an X-window with a window id “window_id” (the last number “0” is the z-stacking and is not currently used).</p>
<p>We can use the window id of an existing Qt widget “some_widget” like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">window_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">some_widget</span><span class="o">.</span><span class="n">winId</span><span class="p">())</span>
</pre></div>
</div>
<p>There is a stripped-down example of this in</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">valkka_examples</span><span class="o">/</span><span class="n">api_level_1</span><span class="o">/</span><span class="n">qt</span><span class="o">/</span>

  <span class="n">single_stream_rtsp</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>You can also let Valkka create the X-window (with correct visual parameters, no XSignals, etc.) and embed that X-window into Qt.  This can be done with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foreign_window</span> <span class="o">=</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QWindow</span><span class="o">.</span><span class="n">fromWinId</span><span class="p">(</span><span class="n">win_id</span><span class="p">)</span>
<span class="n">foreign_widget</span> <span class="o">=</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="o">.</span><span class="n">createWindowContainer</span><span class="p">(</span><span class="n">foreign_window</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
</pre></div>
</div>
<p>where “win_id” is the window_id returned by Valkka, “parent” is the parent widget of the widget we’re creating here and “foreign_widget” is the resulting widget we’re going to use in Qt.</p>
<p>However, “foreign_widget” created this way does not catch mouse gestures.  This can be solved by placing a “dummy” QWidget on top of the “foreign_widget” (using a layout).
An example of this can be found in</p>
</section>
<section id="python-multiprocessing">
<h2>Python multiprocessing<a class="headerlink" href="#python-multiprocessing" title="Link to this heading"></a></h2>
<p>In <a class="reference internal" href="lesson_4.html#opencv-client"><span class="std std-ref">lesson 4</span></a> of the tutorial, we launched a separate python interpreter running a client program that was using decoded and shared frames.</p>
<p>That approach works for Qt programs as well, but it is more convenient to use multiprocesses constructed with
Python3’s <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html">multiprocessing</a> library.</p>
<p>Using python multiprocesses with Qt complicates things a bit: we need a way to map messages from the multiprocess into signals at the main Qt program.
This can be done by communicating with the python multiprocess via pipes and converting the pipe messages into incoming and outgoing Qt signals.</p>
<p>Let’s state that graphically:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Qt main loop running with signals and slots
    |
    +--- QThread receiving/sending signals --- writing/reading communication pipes
                                                                     |
                                                       +-------------+------+----------------+
                                                       |                    |                |
                                                      multiprocess_1   multiprocess_2  multiprocess_3

                                                       python multiprocesses doing their thing
                                                       and writing/reading their communication pipes
                                                       ==&gt; subclass from valkka.multiprocess.MessageProcess
</pre></div>
</div>
<p>Note that we only need a single QThread to control several multiprocesses.</p>
<p>Let’s dig deeper into our strategy for interprocess communication with the Qt signal/slot system:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>+--------------------------------------+
|                                      |
| QThread                              |
|  watching the communication pipe     |
|                   +----- reads &quot;ping&quot;|
|                   |               |  |
+-------------------|------------------+
                    |               |
 +------------------|-------+       |        ...
 | Frontend methods |       |       ^          :
 |                  |       |      pipe        :
 | def ping():  &lt;---+       |       |          :
 |   do something           |       |          :
 |   (say, send a qt signal)|       |          :
 |                          |       |          :
 | def pong(): # qt slot    |       |          :
 |   sendSignal(&quot;pong&quot;) ---------+  |          :
 |                          |    |  |          :    valkka.multiprocess.MessageProcess
 +--------------------------+    |  |          :
 | Backend methods          |    |  |          :    Backend is running in the &quot;background&quot; in its own virtual memory space
 |                          |    |  |          :
 | sendSignal__(&quot;ping&quot;) -------&gt;----+          :
 |                          |    |             :
 | watching childpipe &lt;------- childpipe       :
 |                 |        |                  :
 | def pong__(): &lt;-+        |                  :
 |  do something            |                  :
 |                          |                  :
 +--------------------------+                ..:
</pre></div>
</div>
<p>The class <strong>valkka.multiprocess.MessageProcess</strong> provides a model class that has been derived from python’s <strong>multiprocessing.Process</strong> class.
In MessageProcess, the class has both “frontend” and “backend” methods.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MessageProcess</span></code> class comes with the main libValkka package, but you can also install it separately.</p>
<p>It is documented in detail in <a class="reference external" href="https://elsampsa.github.io/valkka-multiprocess/_build/html/index.html">valkka-multiprocess package documentation</a>.</p>
<p>We highly recommend that you read that documentation as it is important to understand what you are doing here - what is running in the “background”
and what in your main python (Qt) process as including libValkka threads and QThreads into the same mix can easily result in the classical
“fork-combined-with-threading” pitfall, leading to a leaky-crashy program.</p>
<p>Please refer also to <a class="reference internal" href="testsuite.html#testsuite"><span class="std std-ref">the PyQt testsuite</span></a> how to do things correctly.</p>
<p>A stand-alone python multiprocessing/Qt sample program is provided here (without any libValkka components):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">valkka_examples</span><span class="o">/</span><span class="n">api_level_2</span><span class="o">/</span><span class="n">qt</span><span class="o">/</span>

    <span class="n">multiprocessing_demo</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Try it to see the magic of python multiprocessing connected with the Qt signal/slot system.</p>
<p>Finally, for creating a libValkka Qt application having a frontend QThread, that controls OpenCV process(es), take a look at</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">valkka_examples</span><span class="o">/</span><span class="n">api_level_2</span><span class="o">/</span><span class="n">qt</span><span class="o">/</span>

    <span class="n">test_studio_detector</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>And follow the code therein.  You will find these classes:</p>
<ul class="simple">
<li><p><em>MovementDetectorProcess</em> : multiprocess with Qt signals and OpenCV</p></li>
<li><p><em>QHandlerThread</em> : the frontend QThread</p></li>
</ul>
<p>A more full-blown multiprocess orchestration example can be found as in <a class="reference external" href="https://github.com/elsampsa/valkka-examples/tree/master/example_projects/basic">this python package</a>.</p>
</section>
<section id="c-api">
<h2>C++ API<a class="headerlink" href="#c-api" title="Link to this heading"></a></h2>
<p>There is no obligation to use Valkka from python - the API is usable from cpp as well: all python libValkka threads and filters are just swig-wrapped cpp code.</p>
<p>If programming in Qt with C++ is your thing, then you can just forget all that multiprocessing considered here and use cpp threads instead.</p>
<p>Say, you can use Valkka’s FrameFifo and Thread infrastructure to create threads that read frames and feed them to an OpenCV analyzer (written in cpp).</p>
<p>You can also communicate from your custom cpp thread to the python side.  A python program using an example cpp thread (<em>TestThread</em>) which communicates with PyQt signals and slots can be found here:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">valkka_examples</span><span class="o">/</span><span class="n">api_level_2</span><span class="o">/</span><span class="n">qt</span><span class="o">/</span>

    <span class="n">cpp_thread_demo</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>See also the documentation for the cpp source code of <a class="reference external" href="https://elsampsa.github.io/valkka-core/html/classTestThread.html">TestThread</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="decoding.html" class="btn btn-neutral float-left" title="Decoding" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="multi_gpu.html" class="btn btn-neutral float-right" title="Multi-GPU systems" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2020 Sampsa Riikonen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>