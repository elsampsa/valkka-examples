<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>OnVif &amp; Discovery &#8212; Python Media Streaming Framework for Linux  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=e785833e" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Common problems" href="pitfalls.html" />
    <link rel="prev" title="Cloud Streaming" href="cloud.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="onvif-discovery">
<h1>OnVif &amp; Discovery<a class="headerlink" href="#onvif-discovery" title="Link to this heading">¶</a></h1>
<p><em>(Your short primer to SOAP and OnVif)</em></p>
<section id="installing">
<h2>Installing<a class="headerlink" href="#installing" title="Link to this heading">¶</a></h2>
<p>Onvif and discovery come in a <a class="reference external" href="https://github.com/elsampsa/valkka-onvif">separate python package</a> which you need to install with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">valkka</span><span class="o">-</span><span class="n">onvif</span>
</pre></div>
</div>
</section>
<section id="intro">
<h2>Intro<a class="headerlink" href="#intro" title="Link to this heading">¶</a></h2>
<p>OnVif is a remote-control protocol for manipulating IP cameras, developed by <a class="reference external" href="http://www.axis.com">Axis</a>.</p>
<p>You can use it to PTZ (pan-tilt-zoom) the camera, for setting camera’s credentials and resolution, and for almost anything else you can imagine.</p>
<p>OnVif is based on <a class="reference external" href="https://en.wikipedia.org/wiki/SOAP">SOAP</a>, i.e. on sending rather complex XML messages between your client computer and the IP camera.
The messages (remote protocol calls), their responses and the parameters, are defined by <strong>WSDL files</strong>,
which (when visualized nicely) look like <a class="reference external" href="http://www.onvif.org/ver20/ptz/wsdl">this</a>.</p>
<p>For a list of the up-to-date official WSDL files, visit <a class="reference external" href="https://www.onvif.org/profiles/specifications/">here</a>.</p>
</section>
<section id="python-onvif-with-zeep">
<h2>Python OnVif with Zeep<a class="headerlink" href="#python-onvif-with-zeep" title="Link to this heading">¶</a></h2>
<p>We use the <a class="reference external" href="https://github.com/mvantellingen/python-zeep">Zeep</a> opensource SOAP library to communicate with the cameras, with minimum
extra code on top of Zeep.</p>
<p>You also need this table to get started:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>WSDL Declaration</p></th>
<th class="head"><p>Camera http sub address</p></th>
<th class="head"><p>Wsdl file</p></th>
<th class="head"><p>Subclass</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="http://www.onvif.org/ver10/device/wsdl">http://www.onvif.org/ver10/device/wsdl</a></p></td>
<td><p>device_service</p></td>
<td><p>devicemgmt-10.wsdl</p></td>
<td><p>DeviceManagement</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="http://www.onvif.org/ver10/media/wsdl">http://www.onvif.org/ver10/media/wsdl</a></p></td>
<td><p>Media</p></td>
<td><p>media-10.wsdl</p></td>
<td><p>Media</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="http://www.onvif.org/ver10/events/wsdl">http://www.onvif.org/ver10/events/wsdl</a></p></td>
<td><p>Events</p></td>
<td><p>events-10.wsdl</p></td>
<td><p>Events</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="http://www.onvif.org/ver20/ptz/wsdl">http://www.onvif.org/ver20/ptz/wsdl</a></p></td>
<td><p>PTZ</p></td>
<td><p>ptz-20.wsdl</p></td>
<td><p>PTZ</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="http://www.onvif.org/ver20/imaging/wsdl">http://www.onvif.org/ver20/imaging/wsdl</a></p></td>
<td><p>Imaging</p></td>
<td><p>imaging-20.wsdl</p></td>
<td><p>Imaging</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="http://www.onvif.org/ver10/deviceIO/wsdl">http://www.onvif.org/ver10/deviceIO/wsdl</a></p></td>
<td><p>DeviceIO</p></td>
<td><p>deviceio-10.wsdl</p></td>
<td><p>DeviceIO</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="http://www.onvif.org/ver20/analytics/wsdl">http://www.onvif.org/ver20/analytics/wsdl</a></p></td>
<td><p>Analytics</p></td>
<td><p>analytics-20.wsdl</p></td>
<td><p>Analytics</p></td>
</tr>
</tbody>
</table>
<p>Here is an example on how to create your own class for an OnVif device service, based on the class <code class="docutils literal notranslate"><span class="pre">OnVif</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">valkka.onvif</span> <span class="kn">import</span> <span class="n">OnVif</span><span class="p">,</span> <span class="n">getWSDLPath</span>

<span class="c1"># (1) create your own class:</span>

<span class="k">class</span> <span class="nc">DeviceManagement</span><span class="p">(</span><span class="n">OnVif</span><span class="p">):</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="s2">&quot;http://www.onvif.org/ver10/device/wsdl&quot;</span>
    <span class="n">wsdl_file</span> <span class="o">=</span> <span class="n">getWSDLPath</span><span class="p">(</span><span class="s2">&quot;devicemgmt-10.wsdl&quot;</span><span class="p">)</span>
    <span class="n">sub_xaddr</span> <span class="o">=</span> <span class="s2">&quot;device_service&quot;</span>
    <span class="n">port</span>      <span class="o">=</span> <span class="s2">&quot;DeviceBinding&quot;</span>


<span class="c1"># (2) instantiate your class:</span>

<span class="n">device_service</span> <span class="o">=</span> <span class="n">DeviceManagement</span><span class="p">(</span>
    <span class="n">ip</span>          <span class="o">=</span> <span class="s2">&quot;192.168.0.24&quot;</span><span class="p">,</span>
    <span class="n">port</span>        <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">user</span>        <span class="o">=</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
    <span class="n">password</span>    <span class="o">=</span> <span class="s2">&quot;12345&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The implementation of the base class <code class="docutils literal notranslate"><span class="pre">OnVif</span></code> is only a few lines long
(take a look <a class="reference external" href="https://github.com/elsampsa/valkka-onvif/blob/master/valkka/onvif/base.py#L81">here</a>)
and it is based on Zeep.</p>
<p>The things you need for subclassing an OnVif service are:</p>
<ul class="simple">
<li><p>The remote control protocol is declared / visualized in the link at the first column.  Go to <code class="docutils literal notranslate"><span class="pre">http://www.onvif.org/ver10/device/wsdl</span></code> to see the detailed specifications.</p></li>
<li><p>In that specification, we see that the WSDL “port” is <code class="docutils literal notranslate"><span class="pre">DeviceBinding</span></code>.</p></li>
<li><p>Each SOAP remote control protocol comes with a certain namespace.  This is the same as that address in the first column, so we set <code class="docutils literal notranslate"><span class="pre">namespace</span></code> to <code class="docutils literal notranslate"><span class="pre">http://www.onvif.org/ver10/device/wsdl</span></code>.</p></li>
<li><p>We use <em>local modified versions of the wsdl files.</em>  This can be found in the third column, i.e. set <code class="docutils literal notranslate"><span class="pre">wsdl_file</span></code> to <code class="docutils literal notranslate"><span class="pre">devicemgmt-10.wsdl</span></code> (these files are included in <a class="reference external" href="https://github.com/elsampsa/valkka-onvif/tree/master/valkka/onvif/wsdl">valkka-onvif</a>).</p></li>
<li><p>Camera’s local http subaddress <code class="docutils literal notranslate"><span class="pre">sub_xaddr</span></code> is <code class="docutils literal notranslate"><span class="pre">device_service</span></code> (the second column of the table)</p></li>
</ul>
<p>Check out for an example subclass in <a class="reference external" href="https://github.com/elsampsa/valkka-onvif/blob/master/valkka/onvif/base.py#L135">here</a>.</p>
</section>
<section id="service-classes">
<h2>Service classes<a class="headerlink" href="#service-classes" title="Link to this heading">¶</a></h2>
<p>You can create your own OnVif subclass as described above.</p>
<p>However, we have done some of the work for you.  Take a look at the column “Subclass” in the table above, and you’ll find them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">valkka.onvif</span> <span class="kn">import</span> <span class="n">Media</span>

<span class="n">media_service</span> <span class="o">=</span> <span class="n">Media</span><span class="p">(</span>
    <span class="n">ip</span>          <span class="o">=</span> <span class="s2">&quot;192.168.0.24&quot;</span><span class="p">,</span>
    <span class="n">port</span>        <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">user</span>        <span class="o">=</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
    <span class="n">password</span>    <span class="o">=</span> <span class="s2">&quot;12345&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-call">
<h2>Example call<a class="headerlink" href="#example-call" title="Link to this heading">¶</a></h2>
<p>Let’s try a remote protocol call.</p>
<p>If you look at that specification in <code class="docutils literal notranslate"><span class="pre">http://www.onvif.org/ver10/device/wsdl</span></code>, there is a remote protocol call name <code class="docutils literal notranslate"><span class="pre">GetCapabilities</span></code>.  Let’s call it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">valkka.onvif</span> <span class="kn">import</span> <span class="n">DeviceManagement</span>

<span class="n">device_service</span> <span class="o">=</span> <span class="n">DeviceManagement</span><span class="p">(</span>
        <span class="n">ip</span>          <span class="o">=</span> <span class="s2">&quot;192.168.0.24&quot;</span><span class="p">,</span>
        <span class="n">port</span>        <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
        <span class="n">user</span>        <span class="o">=</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="n">password</span>    <span class="o">=</span> <span class="s2">&quot;12345&quot;</span>
        <span class="p">)</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">device_service</span><span class="o">.</span><span class="n">ws_client</span><span class="o">.</span><span class="n">GetCapabilities</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cap</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also pass a variable to that <code class="docutils literal notranslate"><span class="pre">GetCapabilities</span></code> call - variables
are nested objects, that must be constructed separately.  Like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">factory</span> <span class="o">=</span> <span class="n">device_service</span><span class="o">.</span><span class="n">zeep_client</span><span class="o">.</span><span class="n">type_factory</span><span class="p">(</span><span class="s2">&quot;http://www.onvif.org/ver10/schema&quot;</span><span class="p">)</span>
<span class="n">category</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">CapabilityCategory</span><span class="p">(</span><span class="s2">&quot;Device&quot;</span><span class="p">)</span>
<span class="n">cap</span> <span class="o">=</span> <span class="n">device_service</span><span class="o">.</span><span class="n">ws_client</span><span class="o">.</span><span class="n">GetCapabilities</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cap</span><span class="p">)</span>
</pre></div>
</div>
<p>The namespace <code class="docutils literal notranslate"><span class="pre">http://www.onvif.org/ver10/schema</span></code> declares all basic variables used by the wsdl files.  We also provide a short-cut command for that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">category</span> <span class="o">=</span> <span class="n">device_service</span><span class="o">.</span><span class="n">getVariable</span><span class="p">(</span><span class="s2">&quot;Device&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>That’s about it.  Now you are able to remote control your camera.</p>
<p>One extra bonus: to open the specifications directly with Firefox, try this</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">device_service</span><span class="o">.</span><span class="n">openSpecs</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="onvif-pitfalls">
<h2>Onvif Pitfalls<a class="headerlink" href="#onvif-pitfalls" title="Link to this heading">¶</a></h2>
<p><em>Axis cameras</em></p>
<p>Although Axis is <em>the</em> brand that created OnVif, their cameras are extremely picky on the onvif calls: if your client machine’s walltime
differs even slightly on the camera’s time, axis cameras (at least the model I have), reject the call (you’ll get “Sender not Authorized”).</p>
<p>You need to set (manually) your camera’s time equal to your client linux machine’s time - up to a second.  One option
is to establish an NTP server on your linux machine and then tell the camera to use that NTP server to synchronize it’s time.</p>
<p><em>Time durations</em></p>
<p>When specifying durations with Zeep, you must use the <code class="docutils literal notranslate"><span class="pre">isodate</span></code> module, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">isodate</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="n">isodate</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that variable <code class="docutils literal notranslate"><span class="pre">timeout</span></code> can be used with OnVif calls.</p>
</section>
<section id="discovery">
<h2>Discovery<a class="headerlink" href="#discovery" title="Link to this heading">¶</a></h2>
<p>Discovery module uses arp-scan and/or the WSDiscovery protocol.</p>
<p>The API is subject to change and is explained in detail at the <a class="reference external" href="https://github.com/elsampsa/valkka-onvif">valkka-onvif main readme</a></p>
<p>Most importantly, you need to give normal users the ability to perform arp-scans, so before using discovery tools,
do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">arp</span><span class="o">-</span><span class="n">scan</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="n">u</span><span class="o">+</span><span class="n">s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">arp</span><span class="o">-</span><span class="n">scan</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!--link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous"-->

<script src="https://kit.fontawesome.com/1f90d3565b.js" crossorigin="anonymous"></script>

<!-- Place this tag in your head or just before your close body tag. -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

<a href="index.html">
    <img class="logo" src="_static/valkka.png">
</a>

<p>Python Media Streaming Framework for Linux</p>
<a class="github-button" href="https://github.com/elsampsa/valkka-core" data-size="large" data-show-count="true" aria-label="Star elsampsa/valkka-core on GitHub">Star</a>
<!--
<p>
  <iframe src="http://ghbtns.com/github-btn.html?user=elsampsa&repo=valkka-core&type=watch&count=true&size=large" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>
-->

<h3>Links</h3>
<ul>
  <li><a href="https://github.com/elsampsa/valkka-core" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-core </a></li>
  <li><a href="https://github.com/elsampsa/valkka-examples" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-examples </a></li>
  <li><a href="https://github.com/elsampsa/valkka-onvif" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-onvif </a></li>
  <li><a href="https://elsampsa.github.io/valkka-multiprocess/_build/html/index.html" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> valkka-multiprocess </a></li>
  <li><a href="https://github.com/elsampsa/valkka-streamer"target="_blank" rel="noopener noreferrer" ><i class="fab fa-github" ></i> valkka-streamer </a></li>
  <!-- li><a href="https://github.com/elsampsa/darknet-python"><i class="fab fa-github"></i> darknet-python </a></li -->
  <li><a href="https://github.com/elsampsa/valkka-core/issues" target="_blank" rel="noopener noreferrer"><i class="fas fa-bug"></i> Issue Tracker</a></li>
  <li><a href="https://launchpad.net/~sampsa-riikonen/+archive/ubuntu/valkka/+packages" target="_blank" rel="noopener noreferrer"><i class="fas fa-archive"></i> Package Repository</a></li>
  <li><a href="https://hub.docker.com/r/elsampsa/valkka" target="_blank" rel="noopener noreferrer"><i class="fab fa-docker"></i> Dockerhub</a></li>
  <li><a href="https://elsampsa.github.io/valkka-live/" target="_blank" rel="noopener noreferrer"><i class="fas fa-video"></i> Valkka Live</a></li>
  <li><a href="https://discord.com/channels/1116100310574837812/1116101208797609994" target="_blank" rel="noopener noreferrer"> <i class="fa-brands fa-discord"></i> Discord </a> </li>
  <!-- li><a href="http://www.dasys.fi"><i class="fas fa-building"></i> Dasys Ltd.</a></li -->
</ul>

<!-- stupid widgetbot stopped working: let's not use it -->
<!--script src='https://cdn.jsdelivr.net/npm/@widgetbot/crate@3' async defer>
    new Crate({
        server: '1116100310574837812', // ElSampsa's kindergarden
        channel: '1116101208797609994' // #valkka
    })
</script-->
<h3><a href="index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">About Valkka</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware.html">Supported hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="testsuite.html">The PyQt testsuite</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="decoding.html">Decoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="qt_notes.html">Integrating with Qt and multiprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_gpu.html">Multi-GPU systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="valkkafs.html">ValkkaFS</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud.html">Cloud Streaming</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">OnVif &amp; Discovery</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installing">Installing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#intro">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="#python-onvif-with-zeep">Python OnVif with Zeep</a></li>
<li class="toctree-l2"><a class="reference internal" href="#service-classes">Service classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-call">Example call</a></li>
<li class="toctree-l2"><a class="reference internal" href="#onvif-pitfalls">Onvif Pitfalls</a></li>
<li class="toctree-l2"><a class="reference internal" href="#discovery">Discovery</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pitfalls.html">Common problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="repos.html">Repository Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">Licence &amp; Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="knowledge.html">Knowledge Base</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2017-2020 Sampsa Riikonen.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.15</a>
      
      |
      <a href="_sources/onvif.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
    <script>

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-123031237-1']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>